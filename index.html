<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precio de Cascos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #A9A9A9;
            margin: 10px;
            display: flex;
            justify-content: center;
        }
        .container {
            background-color: #BEBEBE;
            padding: 8px;
            border: 2px solid #000;
            border-top-color: #fff;
            border-left-color: #fff;
            width: 100%;
            box-shadow: inset -1px -1px #000, inset 1px 1px #fff;
        }
        h1 {
            text-align: center;
            color: #000066;
            font-size: 14px;
            margin: 5px 0;
            text-transform: uppercase;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #BEBEBE;
            border: 2px solid #000;
            font-size: 11px;
        }
        th, td {
            padding: 4px;
            text-align: center;
            border: 1px solid #808080;
            box-sizing: border-box;
        }
        th {
            background-color: #000066;
            color: white;
            font-weight: normal;
            border-bottom: 2px solid #000;
            font-size: 11px;
        }
        th:nth-child(1), td:nth-child(1) { width: 17.17%; }
        th:nth-child(2), td:nth-child(2) { 
            width: 22.17%; 
            min-width: 90px;
        }
        th:nth-child(3), td:nth-child(3) { width: 12.68%; }
        th:nth-child(4), td:nth-child(4) { 
            width: 22.17%; 
            min-width: 90px;
        }
        th:nth-child(5), td:nth-child(5) { width: 12.68%; }
        th:nth-child(6), td:nth-child(6) { 
            width: 33.13%; 
            min-width: 130px;
        }
        tr:nth-child(2) td, tr:nth-child(4) td, tr:nth-child(6) td, tr:nth-child(8) td {
            background-color: #FFFFFF;
        }
        tr:nth-child(3) td, tr:nth-child(5) td, tr:nth-child(7) td {
            background-color: #D3D3D3;
        }
        tr:nth-child(2) td, tr:nth-child(3) td, tr:nth-child(4) td, tr:nth-child(5) td,
        tr:nth-child(6) td, tr:nth-child(7) td, tr:nth-child(8) td {
            color: #000000;
        }
        tr:nth-child(1) td:nth-child(1),
        tr:nth-child(2) td:nth-child(1),
        tr:nth-child(3) td:nth-child(1),
        tr:nth-child(4) td:nth-child(1),
        tr:nth-child(5) td:nth-child(1),
        tr:nth-child(6) td:nth-child(1),
        tr:nth-child(7) td:nth-child(1),
        tr.total-row td:nth-child(1) {
            font-weight: bold;
        }
        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 3px 2px;
            border: 1px solid #000;
            border-top-color: #808080;
            border-left-color: #808080;
            background-color: #fff;
            box-sizing: border-box;
            font-family: Consolas, monospace;
            font-size: 12px;
            text-align: center;
        }
        input[readonly] {
            background-color: #D3D3D3;
            cursor: default;
        }
        .total-facturado input[readonly], .total-entregado input[readonly] {
            font-size: 11px;
        }
        td:nth-child(2) select, td:nth-child(2) input {
            font-size: 11px;
        }
        select {
            background-color: #fff;
            cursor: pointer;
            font-family: Consolas, monospace;
        }
        .total-row td {
            font-weight: bold;
            background-color: #E0F7E0;
            border: 1px solid #808080;
        }
        .total-row input[readonly], .diferencia-row input[readonly] {
            font-weight: bold;
            font-size: 12px;
            font-family: Consolas, monospace;
        }
        .diferencia-row td {
            background: linear-gradient(to right, #DAA520, #4682B4); /* Restored gradient */
            font-weight: bold;
            color: white;
            border: 1px solid #808080;
            padding: 8px;
        }
        .importe-row td {
            background-color: #000080; /* Restored navy blue */
            font-weight: bold;
            color: white;
            border: 1px solid #808080;
            padding: 8px;
        }
        .pagar-row td {
            background-color: #006400; /* Restored green */
            font-weight: bold;
            color: white;
            border: 1px solid #808080;
            padding: 8px;
        }
        .pagar-row input[readonly] {
            font-weight: bold;
            font-size: 12px;
            color: white;
            background-color: transparent;
            border: none;
            font-family: Consolas, monospace;
        }
        .total-facturado {
            background-color: #DAA520 !important;
        }
        .total-entregado {
            background-color: #4682B4 !important;
        }
        .button {
            padding: 5px 10px;
            margin: 3px;
            border: 2px solid #000;
            border-top-color: #fff;
            border-left-color: #fff;
            background-color: #BEBEBE;
            cursor: pointer;
            font-size: 11px;
        }
        .button:active {
            border-top-color: #000;
            border-left-color: #000;
            border-bottom-color: #fff;
            border-right-color: #fff;
        }
        .reset-button {
            background-color: #8B0000;
            color: white;
            border: 2px solid #000;
            border-top-color: #fff;
            border-left-color: #fff;
        }
        .reset-button:active {
            border-top-color: #000;
            border-left-color: #000;
            border-bottom-color: #fff;
            border-right-color: #fff;
        }
        .pdf-button {
            background-color: #006400;
            color: white;
            border: 2px solid #000;
            border-top-color: #fff;
            border-left-color: #fff;
        }
        .pdf-button:active {
            border-top-color: #000;
            border-left-color: #000;
            border-bottom-color: #fff;
            border-right-color: #fff;
        }
        .info-container {
            width: 50%;
            margin-left: auto;
            margin-bottom: 5px;
            font-size: 11px;
            text-align: left;
        }
        .info-container label {
            font-weight: bold;
            margin-right: 5px;
        }
        .folio-container, .cliente-container {
            margin-bottom: 5px;
        }
        .button-container {
            text-align: center;
            margin: 5px 0;
        }
        .diferencia-row .total-entregado input[readonly],
        .importe-row .total-entregado input[readonly],
        .pagar-row .total-entregado input[readonly] {
            width: 75%;
            box-sizing: border-box;
            font-size: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Precio de Cascos</h1>
        <div class="button-container">
            <button class="reset-button" onclick="reiniciarTabla()">Reiniciar</button>
            <button class="pdf-button" onclick="generarPDF()">Generar PDF</button>
        </div>
        <div class="info-container">
            <div class="folio-container">
                <label for="folioFactura">Folio:</label>
                <input type="text" id="folioFactura" placeholder="Ingresa el folio">
            </div>
            <div class="cliente-container">
                <label for="nombreCliente">Nombre de cliente:</label>
                <input type="text" id="nombreCliente" placeholder="Ingresa el nombre">
            </div>
        </div>
        <table id="cascosTable">
            <thead>
                <tr>
                    <th>Grupo</th>
                    <th>Precio</th>
                    <th>Facturado</th>
                    <th class="total-facturado">Tot. Fact.</th>
                    <th>Entregado</th>
                    <th class="total-entregado">Tot. Entr.</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>GRUPO 1</td>
                    <td>
                        <select onchange="toggleCustomPrice(1)">
                            <option value="">Sel.</option>
                            <option value="341.04">341.04</option>
                            <option value="351.48">351.48</option>
                            <option value="352.64">352.64</option>
                            <option value="358.44">358.44</option>
                            <option value="361.92">361.92</option>
                            <option value="custom">Pers.</option>
                        </select>
                        <input type="number" step="0.01" min="0" id="customPrice1" style="display:none;" oninput="calcularTotales(1)">
                    </td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(1)"></td>
                    <td class="total-facturado"><input type="number" readonly></td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(1)"></td>
                    <td class="total-entregado"><input type="number" readonly></td>
                </tr>
                <tr>
                    <td>GRUPO 2</td>
                    <td>
                        <select onchange="toggleCustomPrice(2)">
                            <option value="">Sel.</option>
                            <option value="443.35">443.35</option>
                            <option value="457.27">457.27</option>
                            <option value="460.75">460.75</option>
                            <option value="466.55">466.55</option>
                            <option value="471.19">471.19</option>
                            <option value="custom">Pers.</option>
                        </select>
                        <input type="number" step="0.01" min="0" id="customPrice2" style="display:none;" oninput="calcularTotales(2)">
                    </td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(2)"></td>
                    <td class="total-facturado"><input type="number" readonly></td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(2)"></td>
                    <td class="total-entregado"><input type="number" readonly></td>
                </tr>
                <tr>
                    <td>GRUPO 3</td>
                    <td>
                        <select onchange="toggleCustomPrice(3)">
                            <option value="">Sel.</option>
                            <option value="579.77">579.77</option>
                            <option value="597.17">597.17</option>
                            <option value="602.97">602.97</option>
                            <option value="608.77">608.77</option>
                            <option value="614.57">614.57</option>
                            <option value="custom">Pers.</option>
                        </select>
                        <input type="number" step="0.01" min="0" id="customPrice3" style="display:none;" oninput="calcularTotales(3)">
                    </td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(3)"></td>
                    <td class="total-facturado"><input type="number" readonly></td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(3)"></td>
                    <td class="total-entregado"><input type="number" readonly></td>
                </tr>
                <tr>
                    <td>GRUPO 4</td>
                    <td>
                        <select onchange="toggleCustomPrice(4)">
                            <option value="">Sel.</option>
                            <option value="682.08">682.08</option>
                            <option value="702.96">702.96</option>
                            <option value="711.08">711.08</option>
                            <option value="716.88">716.88</option>
                            <option value="723.84">723.84</option>
                            <option value="custom">Pers.</option>
                        </select>
                        <input type="number" step="0.01" min="0" id="customPrice4" style="display:none;" oninput="calcularTotales(4)">
                    </td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(4)"></td>
                    <td class="total-facturado"><input type="number" readonly></td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(4)"></td>
                    <td class="total-entregado"><input type="number" readonly></td>
                </tr>
                <tr>
                    <td>GRUPO 5</td>
                    <td>
                        <select onchange="toggleCustomPrice(5)">
                            <option value="">Sel.</option>
                            <option value="852.60">852.60</option>
                            <option value="880.44">880.44</option>
                            <option value="893.20">893.20</option>
                            <option value="899.00">899.00</option>
                            <option value="916.40">916.40</option>
                            <option value="custom">Pers.</option>
                        </select>
                        <input type="number" step="0.01" min="0" id="customPrice5" style="display:none;" oninput="calcularTotales(5)">
                    </td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(5)"></td>
                    <td class="total-facturado"><input type="number" readonly></td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(5)"></td>
                    <td class="total-entregado"><input type="number" readonly></td>
                </tr>
                <tr>
                    <td>GRUPO 6</td>
                    <td>
                        <select onchange="toggleCustomPrice(6)">
                            <option value="">Sel.</option>
                            <option value="1705.20">1705.20</option>
                            <option value="1735.36">1735.36</option>
                            <option value="1763.20">1763.20</option>
                            <option value="1774.80">1774.80</option>
                            <option value="1788.72">1788.72</option>
                            <option value="custom">Pers.</option>
                        </select>
                        <input type="number" step="0.01" min="0" id="customPrice6" style="display:none;" oninput="calcularTotales(6)">
                    </td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(6)"></td>
                    <td class="total-facturado"><input type="number" readonly></td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(6)"></td>
                    <td class="total-entregado"><input type="number" readonly></td>
                </tr>
                <tr>
                    <td>GRUPO 7</td>
                    <td>
                        <select onchange="toggleCustomPrice(7)">
                            <option value="">Sel.</option>
                            <option value="1705.20">1705.20</option>
                            <option value="1760.88">1760.88</option>
                            <option value="1786.40">1786.40</option>
                            <option value="1798.00">1798.00</option>
                            <option value="1832.80">1832.80</option>
                            <option value="custom">Pers.</option>
                        </select>
                        <input type="number" step="0.01" min="0" id="customPrice7" style="display:none;" oninput="calcularTotales(7)">
                    </td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(7)"></td>
                    <td class="total-facturado"><input type="number" readonly></td>
                    <td><input type="number" min="0" max="100" oninput="calcularTotales(7)"></td>
                    <td class="total-entregado"><input type="number" readonly></td>
                </tr>
                <tr class="total-row">
                    <td>TOTAL</td>
                    <td></td>
                    <td></td>
                    <td class="total-facturado"><input type="number" readonly id="totalFacturado"></td>
                    <td></td>
                    <td class="total-entregado"><input type="number" readonly id="totalEntregado"></td>
                </tr>
                <tr class="diferencia-row">
                    <td colspan="5">FACT. - ENTR.</td>
                    <td class="total-entregado"><input type="number" readonly id="diferenciaFacturadoEntregado"></td>
                </tr>
                <tr class="importe-row">
                    <td colspan="5">IMPORTE FACT.</td>
                    <td class="total-entregado"><input type="number" step="0.01" min="0" id="importeFactura" oninput="calcularResultadoFinal()"></td>
                </tr>
                <tr class="pagar-row">
                    <td colspan="5">TOT. A PAGAR</td>
                    <td class="total-entregado"><input type="number" readonly id="totalPagar"></td>
                </tr>
            </tbody>
        </table>
        <div class="button-container">
            <button class="reset-button" onclick="reiniciarTabla()">Reiniciar</button>
            <button class="pdf-button" onclick="generarPDF()">Generar PDF</button>
        </div>
    </div>

    <script>
        function toggleCustomPrice(row) {
            const table = document.getElementById('cascosTable');
            const select = table.rows[row].cells[1].getElementsByTagName('select')[0];
            const input = document.getElementById(`customPrice${row}`);
            if (select.value === 'custom') {
                input.style.display = 'block';
                select.style.display = 'none';
                input.focus();
            } else {
                input.style.display = 'none';
                select.style.display = 'block';
                calcularTotales(row);
            }
        }

        function calcularTotales(row) {
            const table = document.getElementById('cascosTable');
            const select = table.rows[row].cells[1].getElementsByTagName('select')[0];
            const customInput = document.getElementById(`customPrice${row}`);
            const precio = select.value === 'custom' ? 
                (parseFloat(customInput.value) || 0) : 
                (parseFloat(select.value) || 0);
            const facturado = parseFloat(table.rows[row].cells[2].getElementsByTagName('input')[0].value) || 0;
            const entregado = parseFloat(table.rows[row].cells[4].getElementsByTagName('input')[0].value) || 0;

            const totalFacturado = precio * facturado;
            const totalEntregado = precio * entregado;

            table.rows[row].cells[3].getElementsByTagName('input')[0].value = totalFacturado.toFixed(2);
            table.rows[row].cells[5].getElementsByTagName('input')[0].value = totalEntregado.toFixed(2);

            let sumaFacturado = 0;
            let sumaEntregado = 0;
            for (let i = 1; i <= 7; i++) {
                sumaFacturado += parseFloat(table.rows[i].cells[3].getElementsByTagName('input')[0].value) || 0;
                sumaEntregado += parseFloat(table.rows[i].cells[5].getElementsByTagName('input')[0].value) || 0;
            }

            document.getElementById('totalFacturado').value = sumaFacturado.toFixed(2);
            document.getElementById('totalEntregado').value = sumaEntregado.toFixed(2);
            document.getElementById('diferenciaFacturadoEntregado').value = (sumaFacturado - sumaEntregado).toFixed(2);

            calcularResultadoFinal();
        }

        function calcularResultadoFinal() {
            const importeFactura = parseFloat(document.getElementById('importeFactura').value) || 0;
            const diferencia = parseFloat(document.getElementById('diferenciaFacturadoEntregado').value) || 0;
            document.getElementById('totalPagar').value = (importeFactura - diferencia).toFixed(2);
        }

        function reiniciarTabla() {
            const table = document.getElementById('cascosTable');
            for (let i = 1; i <= 7; i++) {
                table.rows[i].cells[1].getElementsByTagName('select')[0].value = '';
                const customInput = document.getElementById(`customPrice${i}`);
                customInput.value = '';
                customInput.style.display = 'none';
                table.rows[i].cells[1].getElementsByTagName('select')[0].style.display = 'block';
                table.rows[i].cells[2].getElementsByTagName('input')[0].value = '';
                table.rows[i].cells[3].getElementsByTagName('input')[0].value = '';
                table.rows[i].cells[4].getElementsByTagName('input')[0].value = '';
                table.rows[i].cells[5].getElementsByTagName('input')[0].value = '';
            }
            document.getElementById('totalFacturado').value = '';
            document.getElementById('totalEntregado').value = '';
            document.getElementById('diferenciaFacturadoEntregado').value = '';
            document.getElementById('importeFactura').value = '';
            document.getElementById('totalPagar').value = '';
            document.getElementById('folioFactura').value = '';
            document.getElementById('nombreCliente').value = '';
        }

        async function generarPDF() {
            console.log('Iniciando generación de PDF...');

            if (typeof html2canvas === 'undefined') {
                console.error('html2canvas no está cargado. Verifica la conexión a internet o el CDN.');
                alert('No se pudo cargar html2canvas. Asegúrate de tener conexión a internet.');
                return;
            }
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                console.error('jsPDF no está cargado. Verifica la conexión a internet o el CDN.');
                alert('No se pudo cargar jsPDF. Asegúrate de tener conexión a internet.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            console.log('jsPDF inicializado correctamente.');

            console.log('Recalculando totales...');
            for (let i = 1; i <= 7; i++) {
                calcularTotales(i);
            }
            calcularResultadoFinal();
            console.log('Totales recalculados.');

            const table = document.getElementById('cascosTable');
            const clonedTable = table.cloneNode(true);
            console.log('Tabla clonada.');

            // Extract the totals before modifying the cloned table
            const diferenciaValue = document.getElementById('diferenciaFacturadoEntregado').value || '0.00';
            const importeValue = document.getElementById('importeFactura').value || '0.00';
            const totalPagarValue = document.getElementById('totalPagar').value || '0.00';

            const rows = clonedTable.rows;
            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].cells;
                for (let j = 0; j < cells.length; j++) {
                    const cell = cells[j];
                    if (j === 1) {
                        const select = table.rows[i].cells[j].getElementsByTagName('select')[0];
                        const customInput = table.rows[i].cells[j].getElementsByTagName('input')[0];
                        if (select && select.value === 'custom' && customInput && customInput.style.display !== 'none') {
                            cell.innerHTML = customInput.value || '';
                        } else if (select) {
                            cell.innerHTML = select.value || '';
                        }
                    } else {
                        const input = cell.querySelector('input');
                        if (input) {
                            cell.innerHTML = input.value || '';
                        }
                    }
                }
            }
            console.log('Valores de la tabla clonada actualizados.');

            const folioInput = document.getElementById('folioFactura');
            const folioValue = folioInput.value || 'Sin folio';
            const clienteInput = document.getElementById('nombreCliente');
            const clienteValue = clienteInput.value || 'Sin cliente';
            console.log('Folio:', folioValue, 'Cliente:', clienteValue);

            const tempContainer = document.createElement('div');
            tempContainer.style.padding = '10px';
            const title = document.createElement('h1');
            title.innerText = 'Precio de Cascos';
            title.style.textAlign = 'center';
            title.style.color = '#000066';
            title.style.fontSize = '14px';
            title.style.margin = '5px 0';
            title.style.textTransform = 'uppercase';
            tempContainer.appendChild(title);

            const infoContainer = document.createElement('div');
            infoContainer.style.width = '50%';
            infoContainer.style.marginLeft = 'auto';
            infoContainer.style.fontSize = '11px';
            infoContainer.style.textAlign = 'left';

            const folioDiv = document.createElement('div');
            folioDiv.style.marginBottom = '5px';
            folioDiv.innerHTML = `<label style="font-weight: bold; margin-right: 5px;">Folio:</label> ${folioValue}`;
            infoContainer.appendChild(folioDiv);

            const clienteDiv = document.createElement('div');
            clienteDiv.style.marginBottom = '5px';
            clienteDiv.innerHTML = `<label style="font-weight: bold; margin-right: 5px;">Nombre de cliente:</label> ${clienteValue}`;
            infoContainer.appendChild(clienteDiv);

            tempContainer.appendChild(infoContainer);
            tempContainer.appendChild(clonedTable);
            console.log('Contenedor temporal creado.');

            // Create a separate section for the totals
            const totalsContainer = document.createElement('div');
            totalsContainer.style.marginTop = '20px';
            totalsContainer.style.fontSize = '12px';
            totalsContainer.style.textAlign = 'left';

            const diferenciaDiv = document.createElement('div');
            diferenciaDiv.innerHTML = `<span style="font-weight: bold; color: #000;">FACT. - ENTR.:</span> ${diferenciaValue}`;
            totalsContainer.appendChild(diferenciaDiv);

            const importeDiv = document.createElement('div');
            importeDiv.innerHTML = `<span style="font-weight: bold; color: #000;">IMPORTE FACT.:</span> ${importeValue}`;
            totalsContainer.appendChild(importeDiv);

            const totalPagarDiv = document.createElement('div');
            totalPagarDiv.innerHTML = `<span style="font-weight: bold; color: #000;">TOT. A PAGAR:</span> ${totalPagarValue}`;
            totalsContainer.appendChild(totalPagarDiv);

            tempContainer.appendChild(totalsContainer);

            tempContainer.style.position = 'absolute';
            tempContainer.style.top = '-9999px';
            document.body.appendChild(tempContainer);
            console.log('Contenedor temporal añadido al DOM.');

            try {
                console.log('Generando canvas con html2canvas...');
                const canvas = await html2canvas(tempContainer, { scale: 2 });
                console.log('Canvas generado:', canvas);

                const imgData = canvas.toDataURL('image/png');
                console.log('Imagen generada:', imgData.substring(0, 50) + '...');

                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                console.log('Dimensiones del PDF - Ancho:', pdfWidth, 'Alto:', pdfHeight);

                doc.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight);
                console.log('Imagen añadida al PDF.');

                doc.save('precio_cascos.pdf');
                console.log('PDF guardado como precio_cascos.pdf.');
            } catch (error) {
                console.error('Error al generar el PDF:', error);
                alert('Hubo un error al generar el PDF: ' + error.message);
            } finally {
                document.body.removeChild(tempContainer);
                console.log('Contenedor temporal eliminado.');
            }
        }
    </script>
</body>
</html>